(function(u,a,k,s,v,f,c,m){"use strict";const F={apiKey:"",serverUrl:""},h=()=>({...F,...f.storage}),w=n=>{Object.assign(f.storage,n)},P=n=>{const r=h();r.apiKey=n,w(r)},D=n=>{const r=h();r.serverUrl=n,w(r)},p=()=>h().apiKey,I=()=>h().serverUrl,A=()=>{const n=h();return n.apiKey.trim()!==""&&n.serverUrl.trim()!==""};v.findByProps("openLazy","hideActionSheet");const S=v.findByProps("ActionSheet")?.ActionSheet,_=v.findByProps("ActionSheetRow")?.ActionSheetRow;let y;const T=async()=>{const n=p(),r=I();if(!n||!r)return a.showToast("Immich not configured!",s.getAssetIDByName("ic_close_16px")),!1;try{console.log("[ImmichSave] Testing connection to:",`${r}/api/server-info/ping`);const o=await fetch(`${r}/api/server-info/ping`,{method:"GET",headers:{"X-API-KEY":n}});return console.log("[ImmichSave] Connection test response:",o.status,o.statusText),o.ok?(a.showToast("\u2705 Immich connection successful!",s.getAssetIDByName("ic_check")),!0):(a.showToast(`\u274C Connection failed: ${o.status}`,s.getAssetIDByName("ic_close_16px")),!1)}catch(o){return console.error("[ImmichSave] Connection test error:",o),a.showToast("\u274C Cannot reach Immich server",s.getAssetIDByName("ic_close_16px")),!1}},$=(n,r)=>{const o=p(),i=I();return!o||!i?(a.showToast("Immich not configured! Please set API key and server URL in settings.",s.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(n).then(e=>{if(!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>{const t=new FormData;return t.append("assetData",e,r),t.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),t.append("deviceId","vendetta-discord"),t.append("fileCreatedAt",new Date().toISOString()),t.append("fileModifiedAt",new Date().toISOString()),console.log("[ImmichSave] Uploading to Immich:",`${i}/api/asset/upload`),console.log("[ImmichSave] API Key length:",o.length),console.log("[ImmichSave] FormData entries:",Array.from(t.entries()).map(([d,l])=>d==="assetData"?[d,`File: ${l.size} bytes`]:[d,l])),fetch(`${i}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":o},body:t})}).then(e=>e.ok?!0:e.text().then(t=>{throw new Error(`Upload failed: ${e.status} - ${t}`)})).catch(e=>{console.error("[ImmichSave] Upload error:",e),console.error("[ImmichSave] Error type:",e.constructor.name),console.error("[ImmichSave] Error stack:",e.stack);let t="Unknown error occurred";return e.message.includes("Network request failed")?t="Cannot connect to Immich server. Check your server URL and network connection.":e.message.includes("Upload failed: 401")?t="Invalid API key. Please check your Immich API key in settings.":e.message.includes("Upload failed: 403")?t="Access denied. Check your API key permissions.":e.message.includes("Upload failed: 404")?t="Immich API endpoint not found. Check your server URL.":e.message.includes("Upload failed: 500")?t="Immich server error. Check server logs.":t=e.message||"Unknown error occurred",a.showToast(`Failed to save: ${t}`,s.getAssetIDByName("ic_close_16px")),!1})},R=n=>{if(!A()){a.showToast("Please configure Immich settings first!",s.getAssetIDByName("ic_close_16px"));return}const r=n.attachments;if(!r||r.length===0){a.showToast("No media found in this message",s.getAssetIDByName("ic_close_16px"));return}const o=r.filter(l=>{const g=l.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(l.filename),B=l.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(l.filename);return g||B});if(o.length===0){a.showToast("No image or video attachments found",s.getAssetIDByName("ic_close_16px"));return}a.showToast(`Uploading ${o.length} file(s) to Immich...`,s.getAssetIDByName("ic_upload"));let i=0,e=0,t=0;const d=l=>$(l.url,l.filename).then(g=>{g?i++:e++,t++,o.length>1&&a.showToast(`Progress: ${t}/${o.length} files processed`,s.getAssetIDByName("ic_check")),t===o.length&&(i>0&&a.showToast(`Successfully saved ${i} file(s) to Immich!`,s.getAssetIDByName("ic_check")),e>0&&a.showToast(`Failed to save ${e} file(s)`,s.getAssetIDByName("ic_close_16px")))}).catch(g=>{e++,t++,t===o.length&&(i>0&&a.showToast(`Successfully saved ${i} file(s) to Immich!`,s.getAssetIDByName("ic_check")),e>0&&a.showToast(`Failed to save ${e} file(s)`,s.getAssetIDByName("ic_close_16px")))});o.forEach(l=>{d(l)})};var U={onLoad:()=>{S&&(y=k.before("render",S,n=>{try{const[r]=n,o=r.header?.props?.message;if(!o||!o.attachments?.some(i=>{const e=i.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(i.filename),t=i.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(i.filename);return e||t}))return;if(r.children&&Array.isArray(r.children)&&_&&!r.children.some(i=>i?.props?.label==="Save to Immich")){const i=c.React.createElement(_,{key:"save-to-immich",label:"Save to Immich",icon:s.getAssetIDByName("ic_download"),onPress:()=>{try{R(o)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),a.showToast(`Failed to save: ${e.message||"Unknown error"}`,s.getAssetIDByName("ic_close_16px"))}}});r.children.unshift(i)}}catch(r){console.error("[ImmichSave] ActionSheet patch error:",r)}}))},onUnload:()=>{y&&y()},settings:()=>{const[n,r]=c.React.useState(p()),[o,i]=c.React.useState(I()),e=()=>{P(n),a.showToast("API Key saved!",s.getAssetIDByName("ic_check"))},t=()=>{D(o),a.showToast("Server URL saved!",s.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(m.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(m.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),c.React.createElement(m.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:n,onChange:r,secureTextEntry:!0}),c.React.createElement(m.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(m.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:o,onChange:i}),c.React.createElement(m.Forms.FormRow,{label:"Save Server URL",onPress:t}),c.React.createElement(m.Forms.FormRow,{label:"Test Connection",onPress:T})),c.React.createElement(m.Forms.FormSection,{title:"Status"},c.React.createElement(m.Forms.FormText,{style:{marginBottom:10}},A()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return u.default=U,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
