(function(g,s,_,i,u,f,c,l){"use strict";const k={apiKey:"",serverUrl:""},h=()=>({...k,...f.storage}),y=a=>{Object.assign(f.storage,a)},P=a=>{const r=h();r.apiKey=a,y(r)},D=a=>{const r=h();r.serverUrl=a,y(r)},p=()=>h().apiKey,v=()=>h().serverUrl,A=()=>{const a=h();return a.apiKey.trim()!==""&&a.serverUrl.trim()!==""};u.findByProps("openLazy","hideActionSheet");const w=u.findByProps("ActionSheet")?.ActionSheet,S=u.findByProps("ActionSheetRow")?.ActionSheetRow;let I;const F=()=>{const a=p(),r=v();if(!a||!r){s.showToast("Immich not configured!",i.getAssetIDByName("ic_close_16px"));return}console.log("[ImmichSave] Testing connection to:",`${r}/api/albums`),fetch(`${r}/api/albums`,{method:"GET",headers:{"X-API-KEY":a}}).then(o=>{console.log("[ImmichSave] Connection test response:",o.status,o.statusText),o.ok?s.showToast("\u2705 Immich connection successful!",i.getAssetIDByName("ic_check")):s.showToast(`\u274C Connection failed: ${o.status}`,i.getAssetIDByName("ic_close_16px"))}).catch(o=>{console.error("[ImmichSave] Connection test error:",o),s.showToast("\u274C Cannot reach Immich server",i.getAssetIDByName("ic_close_16px"))})},T=(a,r)=>{const o=p(),n=v();return!o||!n?(s.showToast("Immich not configured! Please set API key and server URL in settings.",i.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(a).then(e=>{if(!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>{const t=new FormData;return t.append("assetData",e,r),t.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),t.append("deviceId","vendetta-discord"),t.append("fileCreatedAt",new Date().toISOString()),t.append("fileModifiedAt",new Date().toISOString()),t.append("filename",r),t.append("metadata",JSON.stringify([])),console.log("[ImmichSave] Uploading to Immich:",`${n}/api/asset/upload`),console.log("[ImmichSave] API Key length:",o.length),console.log("[ImmichSave] FormData prepared with keys:",["assetData","deviceAssetId","deviceId","fileCreatedAt","fileModifiedAt","filename","metadata"]),console.log("[ImmichSave] Blob size:",e.size,"bytes"),fetch(`${n}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":o},body:t})}).then(e=>e.ok?!0:e.text().then(t=>{throw new Error(`Upload failed: ${e.status} - ${t}`)})).catch(e=>{console.error("[ImmichSave] Upload error:",e),console.error("[ImmichSave] Error type:",e.constructor.name),console.error("[ImmichSave] Error stack:",e.stack);let t="Unknown error occurred";return e.message.includes("Network request failed")?t="Cannot connect to Immich server. Check your server URL and network connection.":e.message.includes("Upload failed: 401")?t="Invalid API key. Please check your Immich API key in settings.":e.message.includes("Upload failed: 403")?t="Access denied. Check your API key permissions.":e.message.includes("Upload failed: 404")?t="Immich API endpoint not found. Check your server URL.":e.message.includes("Upload failed: 500")?t="Immich server error. Check server logs.":t=e.message||"Unknown error occurred",s.showToast(`Failed to save: ${t}`,i.getAssetIDByName("ic_close_16px")),!1})},B=a=>{if(!A()){s.showToast("Please configure Immich settings first!",i.getAssetIDByName("ic_close_16px"));return}const r=a.attachments;if(!r||r.length===0){s.showToast("No media found in this message",i.getAssetIDByName("ic_close_16px"));return}const o=r.filter(m=>{const d=m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(m.filename),U=m.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(m.filename);return d||U});if(o.length===0){s.showToast("No image or video attachments found",i.getAssetIDByName("ic_close_16px"));return}s.showToast(`Uploading ${o.length} file(s) to Immich...`,i.getAssetIDByName("ic_upload"));let n=0,e=0,t=0;const R=m=>T(m.url,m.filename).then(d=>{d?n++:e++,t++,o.length>1&&s.showToast(`Progress: ${t}/${o.length} files processed`,i.getAssetIDByName("ic_check")),t===o.length&&(n>0&&s.showToast(`Successfully saved ${n} file(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,i.getAssetIDByName("ic_close_16px")))}).catch(d=>{e++,t++,t===o.length&&(n>0&&s.showToast(`Successfully saved ${n} file(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,i.getAssetIDByName("ic_close_16px")))});o.forEach(m=>{R(m)})};var E={onLoad:()=>{w&&(I=_.before("render",w,a=>{try{const[r]=a,o=r.header?.props?.message;if(!o||!o.attachments?.some(n=>{const e=n.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(n.filename),t=n.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(n.filename);return e||t}))return;if(r.children&&Array.isArray(r.children)&&S&&!r.children.some(n=>n?.props?.label==="Save to Immich")){const n=c.React.createElement(S,{key:"save-to-immich",label:"Save to Immich",icon:i.getAssetIDByName("ic_download"),onPress:()=>{try{B(o)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),s.showToast(`Failed to save: ${e.message||"Unknown error"}`,i.getAssetIDByName("ic_close_16px"))}}});r.children.unshift(n)}}catch(r){console.error("[ImmichSave] ActionSheet patch error:",r)}}))},onUnload:()=>{I&&I()},settings:()=>{const[a,r]=c.React.useState(p()),[o,n]=c.React.useState(v()),e=()=>{P(a),s.showToast("API Key saved!",i.getAssetIDByName("ic_check"))},t=()=>{D(o),s.showToast("Server URL saved!",i.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(l.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:a,onChange:r,secureTextEntry:!0}),c.React.createElement(l.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:o,onChange:n}),c.React.createElement(l.Forms.FormRow,{label:"Save Server URL",onPress:t}),c.React.createElement(l.Forms.FormRow,{label:"Test Connection",onPress:F})),c.React.createElement(l.Forms.FormSection,{title:"Status"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},A()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=E,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
