(function(g,d,n,i,f,c,l,w,_){"use strict";const A={apiKey:"",serverUrl:""},h=()=>({...A,...f.storage}),v=r=>{Object.assign(f.storage,r)},F=r=>{const o=h();o.apiKey=r,v(o)},E=r=>{const o=h();o.serverUrl=r,v(o)},y=()=>h().apiKey,I=()=>h().serverUrl,S=()=>{const r=h();return r.apiKey.trim()!==""&&r.serverUrl.trim()!==""};let u=[];const R=()=>{d.findByStoreName("ChannelStore"),d.findByStoreName("MessageStore")},b=(r,o)=>{const a=y(),s=I();return!a||!s?(n.showToast("Immich not configured! Please set API key and server URL in settings.",i.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(r).then(e=>{if(!e.ok)throw new Error(`Failed to download image: ${e.status}`);return e.blob()}).then(e=>{const t=new FormData;return t.append("assetData",e,o),t.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),t.append("deviceId","vendetta-discord"),t.append("fileCreatedAt",new Date().toISOString()),t.append("fileModifiedAt",new Date().toISOString()),fetch(`${s}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":a},body:t})}).then(e=>e.ok?!0:e.text().then(t=>{throw new Error(`Upload failed: ${e.status} - ${t}`)})).catch(e=>(console.error("Immich upload error:",e),n.showToast(`Upload failed: ${e.message}`,i.getAssetIDByName("ic_close_16px")),!1))},B=r=>{if(!S()){n.showToast("Please configure Immich settings first!",i.getAssetIDByName("ic_close_16px"));return}const o=r.attachments;if(!o||o.length===0){n.showToast("No images found in this message",i.getAssetIDByName("ic_close_16px"));return}const a=o.filter(m=>m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(m.filename));if(a.length===0){n.showToast("No image attachments found",i.getAssetIDByName("ic_close_16px"));return}let s=0,e=0,t=0;const P=m=>b(m.url,m.filename).then(p=>{p?s++:e++,t++,t===a.length&&(s>0&&n.showToast(`Successfully saved ${s} image(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&n.showToast(`Failed to save ${e} image(s)`,i.getAssetIDByName("ic_close_16px")))}).catch(p=>{e++,t++,console.error("Error processing attachment:",p),t===a.length&&(s>0&&n.showToast(`Successfully saved ${s} image(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&n.showToast(`Failed to save ${e} image(s)`,i.getAssetIDByName("ic_close_16px")))});a.forEach(m=>{P(m)})};var D={onLoad:()=>{R();const r=w.before("render",d.findByProps("ScrollView").View,o=>{try{let a=_.findInReactTree(o,t=>t.key===".$MessageOverflow");if(!a||!a.props||a.props.sheetKey!=="MessageOverflow")return;const s=a.props.content.props;if(!s.options||s.options.some(t=>t?.label==="Save to Immich"))return;const e=a.props.message;if(!e||!e.attachments||e.attachments.length===0||!e.attachments.some(t=>t.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(t.filename)))return;s.options.unshift({label:"Save to Immich",onPress:()=>{try{B(e),s.hideActionSheet()}catch(t){console.error("Error saving to Immich:",t),n.showToast("Failed to save images to Immich",i.getAssetIDByName("ic_close_16px"))}}})}catch(a){console.error("Context menu patch error:",a)}});u.push(r)},onUnload:()=>{u.forEach(r=>{try{r()}catch(o){console.error("Error unpatching:",o)}}),u=[]},settings:()=>{const[r,o]=c.React.useState(y()),[a,s]=c.React.useState(I()),e=()=>{F(r),n.showToast("API Key saved!",i.getAssetIDByName("ic_check"))},t=()=>{E(a),n.showToast("Server URL saved!",i.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(l.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:r,onChange:o,secureTextEntry:!0}),c.React.createElement(l.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:a,onChange:s}),c.React.createElement(l.Forms.FormRow,{label:"Save Server URL",onPress:t})),c.React.createElement(l.Forms.FormSection,{title:"Status"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10}},S()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=D,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.metro,vendetta.ui.toasts,vendetta.ui.assets,vendetta.plugin,vendetta.metro.common,vendetta.ui.components,vendetta.patcher,vendetta.utils);
