(function(y,d,l,c,S,h,p,v,F){"use strict";const E={apiKey:"",serverUrl:""},u=()=>({...E,...S.storage}),w=n=>{Object.assign(S.storage,n)},B=n=>{const s=u();s.apiKey=n,w(s)},D=n=>{const s=u();s.serverUrl=n,w(s)},A=()=>u().apiKey,_=()=>u().serverUrl,b=()=>{const n=u();return n.apiKey.trim()!==""&&n.serverUrl.trim()!==""};let f=[];const P=()=>{d.findByStoreName("ChannelStore"),d.findByStoreName("MessageStore")},N=(n,s)=>{const i=A(),o=_();return!i||!o?(l.showToast("Immich not configured! Please set API key and server URL in settings.",c.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(n).then(t=>{if(!t.ok)throw new Error(`Failed to download image: ${t.status}`);return t.blob()}).then(t=>{const e=new FormData;return e.append("assetData",t,s),e.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),e.append("deviceId","vendetta-discord"),e.append("fileCreatedAt",new Date().toISOString()),e.append("fileModifiedAt",new Date().toISOString()),fetch(`${o}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":i},body:e})}).then(t=>t.ok?!0:t.text().then(e=>{throw new Error(`Upload failed: ${t.status} - ${e}`)})).catch(t=>(console.error("Immich upload error:",t),l.showToast(`Upload failed: ${t.message}`,c.getAssetIDByName("ic_close_16px")),!1))},I=n=>{if(!b()){l.showToast("Please configure Immich settings first!",c.getAssetIDByName("ic_close_16px"));return}const s=n.attachments;if(!s||s.length===0){l.showToast("No images found in this message",c.getAssetIDByName("ic_close_16px"));return}const i=s.filter(r=>r.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(r.filename));if(i.length===0){l.showToast("No image attachments found",c.getAssetIDByName("ic_close_16px"));return}let o=0,t=0,e=0;const a=r=>N(r.url,r.filename).then(g=>{g?o++:t++,e++,e===i.length&&(o>0&&l.showToast(`Successfully saved ${o} image(s) to Immich!`,c.getAssetIDByName("ic_check")),t>0&&l.showToast(`Failed to save ${t} image(s)`,c.getAssetIDByName("ic_close_16px")))}).catch(g=>{t++,e++,console.error("Error processing attachment:",g),e===i.length&&(o>0&&l.showToast(`Successfully saved ${o} image(s) to Immich!`,c.getAssetIDByName("ic_check")),t>0&&l.showToast(`Failed to save ${t} image(s)`,c.getAssetIDByName("ic_close_16px")))});i.forEach(r=>{a(r)})},T=n=>{try{I(n)}catch(s){console.error("Error in Immich action:",s),l.showToast("Failed to save images to Immich",c.getAssetIDByName("ic_close_16px"))}};var R={onLoad:()=>{P();let n=null;const s=["MessageContent","Message","MessageComponent","MessageContainer","MessageWrapper"];for(const o of s)try{const t=d.findByProps(o)?.[o];if(t){console.log(`Found message component: ${o}`),n=v.before("render",t,e=>{try{const[a]=e,r=a.message||a.messageData||a.data;if(!r||!r.attachments||r.attachments.length===0||!r.attachments.some(m=>m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(m.filename)))return;const g=a.onLongPress;a.onLongPress=m=>{g&&g(m),T(r)}}catch(a){console.error("Message content patch error:",a)}});break}}catch{console.log(`Component ${o} not found, trying next...`);continue}n?f.push(n):console.warn("Could not find any message component to patch");let i=null;try{const o=d.findByProps("ActionSheet")?.ActionSheet;o?(console.log("Found ActionSheet component"),i=v.before("render",o,t=>{try{const[e]=t;if(e.sheetKey!=="MessageOverflow")return;const a=e.message||e.content?.props?.message;if(!a||!a.attachments||a.attachments.length===0||!a.attachments.some(r=>r.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(r.filename)))return;e.options&&!e.options.some(r=>r?.label==="Save to Immich")&&e.options.unshift({label:"Save to Immich",icon:c.getAssetIDByName("ic_download"),onPress:()=>{try{I(a),e.hideActionSheet?.()}catch(r){console.error("Error saving to Immich:",r),l.showToast("Failed to save images to Immich",c.getAssetIDByName("ic_close_16px"))}}})}catch(e){console.error("ActionSheet patch error:",e)}})):console.warn("Could not find ActionSheet component")}catch(o){console.error("Error setting up ActionSheet patch:",o)}if(i&&f.push(i),!n&&!i){console.log("Trying fallback ScrollView approach...");try{const o=d.findByProps("ScrollView")?.View;if(o){console.log("Found ScrollView component for fallback");const t=v.before("render",o,e=>{try{let a=F.findInReactTree(e,m=>m.key===".$MessageOverflow");if(!a||!a.props||a.props.sheetKey!=="MessageOverflow")return;const r=a.props.content?.props;if(!r?.options||r.options.some(m=>m?.label==="Save to Immich"))return;const g=a.props.message;if(!g||!g.attachments||g.attachments.length===0||!g.attachments.some(m=>m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(m.filename)))return;r.options.unshift({label:"Save to Immich",icon:c.getAssetIDByName("ic_download"),onPress:()=>{try{I(g),r.hideActionSheet?.()}catch(m){console.error("Error saving to Immich:",m),l.showToast("Failed to save images to Immich",c.getAssetIDByName("ic_close_16px"))}}})}catch(a){console.error("Fallback ScrollView patch error:",a)}});f.push(t)}}catch(o){console.error("Error setting up fallback ScrollView patch:",o)}}},onUnload:()=>{f.forEach(n=>{try{n()}catch(s){console.error("Error unpatching:",s)}}),f=[]},settings:()=>{const[n,s]=h.React.useState(A()),[i,o]=h.React.useState(_()),t=()=>{B(n),l.showToast("API Key saved!",c.getAssetIDByName("ic_check"))},e=()=>{D(i),l.showToast("Server URL saved!",c.getAssetIDByName("ic_check"))};return h.React.createElement(h.React.Fragment,null,h.React.createElement(p.Forms.FormSection,{title:"Immich Configuration"},h.React.createElement(p.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),h.React.createElement(p.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:n,onChange:s,secureTextEntry:!0}),h.React.createElement(p.Forms.FormRow,{label:"Save API Key",onPress:t}),h.React.createElement(p.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:i,onChange:o}),h.React.createElement(p.Forms.FormRow,{label:"Save Server URL",onPress:e})),h.React.createElement(p.Forms.FormSection,{title:"Status"},h.React.createElement(p.Forms.FormText,{style:{marginBottom:10}},b()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return y.default=R,Object.defineProperty(y,"__esModule",{value:!0}),y})({},vendetta.metro,vendetta.ui.toasts,vendetta.ui.assets,vendetta.plugin,vendetta.metro.common,vendetta.ui.components,vendetta.patcher,vendetta.utils);
