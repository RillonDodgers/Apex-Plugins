(function(g,s,S,i,u,y,c,l){"use strict";const k={apiKey:"",serverUrl:""},h=()=>({...k,...y.storage}),I=n=>{Object.assign(y.storage,n)},F=n=>{const r=h();r.apiKey=n,I(r)},P=n=>{const r=h();r.serverUrl=n,I(r)},p=()=>h().apiKey,v=()=>h().serverUrl,w=()=>{const n=h();return n.apiKey.trim()!==""&&n.serverUrl.trim()!==""};u.findByProps("openLazy","hideActionSheet");const A=u.findByProps("ActionSheet")?.ActionSheet,_=u.findByProps("ActionSheetRow")?.ActionSheetRow;let f;const R=()=>{const n=p(),r=v();if(!n||!r){s.showToast("Immich not configured!",i.getAssetIDByName("ic_close_16px"));return}fetch(`${r}/api/albums`,{method:"GET",headers:{"X-API-KEY":n,Accept:"application/json"}}).then(a=>{a.status===200||a.status===401?s.showToast("\u2705 Immich connection successful!",i.getAssetIDByName("ic_check")):s.showToast(`\u274C Connection failed: ${a.status}`,i.getAssetIDByName("ic_close_16px"))}).catch(a=>{s.showToast(`\u274C Cannot reach server: ${a.message}`,i.getAssetIDByName("ic_close_16px"))})},B=(n,r)=>{const a=p(),o=v();return!a||!o?(s.showToast("Immich not configured! Please set API key and server URL in settings.",i.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(n).then(e=>{if(!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>{const t=new FormData;return t.append("assetData",e,r),t.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),t.append("deviceId","vendetta-discord"),t.append("fileCreatedAt",new Date().toISOString()),t.append("fileModifiedAt",new Date().toISOString()),t.append("filename",r),t.append("metadata",JSON.stringify([])),fetch(`${o}/api/assets`,{method:"POST",headers:{"x-api-key":a,Accept:"application/json"},body:t})}).then(e=>e.ok?!0:e.text().then(t=>{throw new Error(`Upload failed: ${e.status} - ${t}`)})).catch(e=>{let t="Unknown error occurred";return e.message.includes("Network request failed")?t="Cannot connect to Immich server. Check your server URL and network connection.":e.message.includes("Upload failed: 401")?t="Invalid API key. Please check your Immich API key in settings.":e.message.includes("Upload failed: 403")?t="Access denied. Check your API key permissions.":e.message.includes("Upload failed: 404")?t="Immich API endpoint not found. Check your server URL.":e.message.includes("Upload failed: 500")?t="Immich server error. Check server logs.":t=e.message||"Unknown error occurred",s.showToast(`Failed to save: ${t}`,i.getAssetIDByName("ic_close_16px")),!1})},D=n=>{if(!w()){s.showToast("Please configure Immich settings first!",i.getAssetIDByName("ic_close_16px"));return}const r=n.attachments;if(!r||r.length===0){s.showToast("No media found in this message",i.getAssetIDByName("ic_close_16px"));return}const a=r.filter(m=>{const d=m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(m.filename),N=m.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(m.filename);return d||N});if(a.length===0){s.showToast("No image or video attachments found",i.getAssetIDByName("ic_close_16px"));return}s.showToast(`Uploading ${a.length} file(s) to Immich...`,i.getAssetIDByName("ic_upload"));let o=0,e=0,t=0;const $=m=>B(m.url,m.filename).then(d=>{d?o++:e++,t++,a.length>1&&s.showToast(`Progress: ${t}/${a.length} files processed`,i.getAssetIDByName("ic_check")),t===a.length&&(o>0&&s.showToast(`Successfully saved ${o} file(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,i.getAssetIDByName("ic_close_16px")))}).catch(d=>{e++,t++,t===a.length&&(o>0&&s.showToast(`Successfully saved ${o} file(s) to Immich!`,i.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,i.getAssetIDByName("ic_close_16px")))});a.forEach(m=>{$(m)})};var T={onLoad:()=>{A&&(f=S.before("render",A,n=>{try{const[r]=n,a=r.header?.props?.message;if(!a||!a.attachments?.some(o=>{const e=o.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(o.filename),t=o.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(o.filename);return e||t}))return;if(r.children&&Array.isArray(r.children)&&_&&!r.children.some(o=>o?.props?.label==="Save to Immich")){const o=c.React.createElement(_,{key:"save-to-immich",label:"Save to Immich",icon:i.getAssetIDByName("ic_download"),onPress:()=>{try{D(a)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),s.showToast(`Failed to save: ${e.message||"Unknown error"}`,i.getAssetIDByName("ic_close_16px"))}}});r.children.unshift(o)}}catch(r){console.error("[ImmichSave] ActionSheet patch error:",r)}}))},onUnload:()=>{f&&f()},settings:()=>{const[n,r]=c.React.useState(p()),[a,o]=c.React.useState(v()),e=()=>{F(n),s.showToast("API Key saved!",i.getAssetIDByName("ic_check"))},t=()=>{P(a),s.showToast("Server URL saved!",i.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(l.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:n,onChange:r,secureTextEntry:!0}),c.React.createElement(l.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(l.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:a,onChange:o}),c.React.createElement(l.Forms.FormRow,{label:"Save Server URL",onPress:t}),c.React.createElement(l.Forms.FormRow,{label:"Test Connection",onPress:R})),c.React.createElement(l.Forms.FormSection,{title:"Status"},c.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},w()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=T,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
