(function(v,i,F,c,I,w,n,g){"use strict";const R={apiKey:"",serverUrl:""},p=()=>({...R,...w.storage}),A=r=>{Object.assign(w.storage,r)},b=r=>{const e=p();e.apiKey=r,A(e)},D=r=>{const e=p();e.serverUrl=r,A(e)},f=()=>p().apiKey,y=()=>p().serverUrl,_=()=>{const r=p();return r.apiKey.trim()!==""&&r.serverUrl.trim()!==""};I.findByProps("openLazy","hideActionSheet");const U=I.findByProps("ActionSheet")?.ActionSheet,k=I.findByProps("ActionSheetRow")?.ActionSheetRow;let S;const E=()=>{const r=f(),e=y();if(!r||!e){i.showToast("Immich not configured!",c.getAssetIDByName("ic_close_16px"));return}fetch(`${e}/api/albums`,{method:"GET",headers:{"X-API-KEY":r,Accept:"application/json"}}).then(t=>{t.status===200||t.status===401?i.showToast("\u2705 Immich connection successful!",c.getAssetIDByName("ic_check")):i.showToast(`\u274C Connection failed: ${t.status}`,c.getAssetIDByName("ic_close_16px"))}).catch(t=>{i.showToast(`\u274C Cannot reach server: ${t.message}`,c.getAssetIDByName("ic_close_16px"))})},P=(r,e)=>{const t=f(),a=y();if(!t||!a)return i.showToast("Immich not configured! Please set API key and server URL in settings.",c.getAssetIDByName("ic_close_16px")),Promise.resolve(!1);console.log("[ImmichSave] Starting upload for:",e),console.log("[ImmichSave] File URL:",r),console.log("[ImmichSave] Server URL:",a),console.log("[ImmichSave] API Key length:",t.length);const s=new FormData,l=o=>{switch(o.toLowerCase().split(".").pop()){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"webp":return"image/webp";case"bmp":return"image/bmp";case"svg":return"image/svg+xml";case"mp4":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";case"mkv":return"video/x-matroska";case"webm":return"video/webm";default:return"application/octet-stream"}};console.log("[ImmichSave] Creating FormData with URI approach"),console.log("[ImmichSave] - File URL:",r),console.log("[ImmichSave] - Filename:",e);const u=l(e);console.log("[ImmichSave] - Detected content type:",u),s.append("assetData",{uri:r,name:e,type:u});const h=`${e.match(/\d+/g)?.join("")||""}-${Date.now()}`;s.append("deviceAssetId",h),s.append("deviceId","discord-mobile-v2");const d=new Date().toISOString();return s.append("fileCreatedAt",d),s.append("fileModifiedAt",d),console.log("[ImmichSave] FormData prepared with URI approach"),console.log("[ImmichSave] Uploading to:",`${a}/api/assets`),fetch(`${a}/api/assets`,{method:"POST",headers:{"x-api-key":t,Accept:"application/json"},body:s}).then(o=>(console.log("[ImmichSave] Upload response status:",o.status,o.statusText),console.log("[ImmichSave] Upload response headers:",Object.fromEntries(o.headers.entries())),o.ok?o.text().then(m=>(console.log("[ImmichSave] Upload success response:",m),!0)):o.text().then(m=>{throw console.log("[ImmichSave] Upload error response body:",m),new Error(`Upload failed: ${o.status} - ${m}`)}))).catch(o=>{console.error("[ImmichSave] Upload error:",o),console.error("[ImmichSave] Error message:",o.message),console.error("[ImmichSave] Error type:",o.constructor.name),console.error("[ImmichSave] Error stack:",o.stack);let m="Unknown error occurred";return o.message.includes("Network request failed")?m="Cannot connect to Immich server. Check your server URL and network connection.":o.message.includes("Upload failed: 401")?m="Invalid API key. Please check your Immich API key in settings.":o.message.includes("Upload failed: 403")?m="Access denied. Check your API key permissions.":o.message.includes("Upload failed: 404")?m="Immich API endpoint not found. Check your server URL.":o.message.includes("Upload failed: 500")?m="Immich server error. Check server logs.":m=o.message||"Unknown error occurred",i.showToast(`Failed to save: ${m}`,c.getAssetIDByName("ic_close_16px")),!1})},T=r=>{if(!_()){i.showToast("Please configure Immich settings first!",c.getAssetIDByName("ic_close_16px"));return}const e=r.attachments;if(!e||e.length===0){i.showToast("No media found in this message",c.getAssetIDByName("ic_close_16px"));return}const t=e.filter(h=>{const d=h.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(h.filename),o=h.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(h.filename);return d||o});if(t.length===0){i.showToast("No image or video attachments found",c.getAssetIDByName("ic_close_16px"));return}i.showToast(`Uploading ${t.length} file(s) to Immich...`,c.getAssetIDByName("ic_upload"));let a=0,s=0,l=0;const u=h=>P(h.url,h.filename).then(d=>{d?a++:s++,l++,t.length>1&&i.showToast(`Progress: ${l}/${t.length} files processed`,c.getAssetIDByName("ic_check")),l===t.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,c.getAssetIDByName("ic_check")),s>0&&i.showToast(`Failed to save ${s} file(s)`,c.getAssetIDByName("ic_close_16px")))}).catch(d=>{s++,l++,l===t.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,c.getAssetIDByName("ic_check")),s>0&&i.showToast(`Failed to save ${s} file(s)`,c.getAssetIDByName("ic_close_16px")))});t.forEach(h=>{u(h)})};var B={onLoad:()=>{U&&(S=F.before("render",U,r=>{try{const[e]=r,t=e.header?.props?.message;if(!t||!t.attachments?.some(a=>{const s=a.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.filename),l=a.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(a.filename);return s||l}))return;if(e.children&&Array.isArray(e.children)&&k&&!e.children.some(a=>a?.props?.label==="Save to Immich")){const a=n.React.createElement(k,{key:"save-to-immich",label:"Save to Immich",icon:c.getAssetIDByName("ic_download"),onPress:()=>{try{T(t)}catch(s){console.error("[ImmichSave] Error in Save to Immich handler:",s),i.showToast(`Failed to save: ${s.message||"Unknown error"}`,c.getAssetIDByName("ic_close_16px"))}}});e.children.unshift(a)}}catch(e){console.error("[ImmichSave] ActionSheet patch error:",e)}}))},onUnload:()=>{S&&S()},settings:()=>{const[r,e]=n.React.useState(f()),[t,a]=n.React.useState(y()),s=()=>{b(r),i.showToast("API Key saved!",c.getAssetIDByName("ic_check"))},l=()=>{D(t),i.showToast("Server URL saved!",c.getAssetIDByName("ic_check"))};return n.React.createElement(n.React.Fragment,null,n.React.createElement(g.Forms.FormSection,{title:"Immich Configuration"},n.React.createElement(g.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),n.React.createElement(g.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:r,onChange:e,secureTextEntry:!0}),n.React.createElement(g.Forms.FormRow,{label:"Save API Key",onPress:s}),n.React.createElement(g.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:t,onChange:a}),n.React.createElement(g.Forms.FormRow,{label:"Save Server URL",onPress:l}),n.React.createElement(g.Forms.FormRow,{label:"Test Connection",onPress:E})),n.React.createElement(g.Forms.FormSection,{title:"Status"},n.React.createElement(g.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},_()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return v.default=B,Object.defineProperty(v,"__esModule",{value:!0}),v})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
