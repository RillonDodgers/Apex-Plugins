(function(v,i,R,n,f,A,c,h){"use strict";const b={apiKey:"",serverUrl:""},g=()=>({...b,...A.storage}),_=r=>{Object.assign(A.storage,r)},P=r=>{const o=g();o.apiKey=r,_(o)},B=r=>{const o=g();o.serverUrl=r,_(o)},y=()=>g().apiKey,I=()=>g().serverUrl,U=()=>{const r=g();return r.apiKey.trim()!==""&&r.serverUrl.trim()!==""};function T(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+r/4).toString(16))}f.findByProps("openLazy","hideActionSheet");const F=f.findByProps("ActionSheet")?.ActionSheet,k=f.findByProps("ActionSheetRow")?.ActionSheetRow;let S;const E=()=>{const r=y(),o=I();if(!r||!o){i.showToast("Immich not configured!",n.getAssetIDByName("ic_close_16px"));return}fetch(`${o}/api/albums`,{method:"GET",headers:{"X-API-KEY":r,Accept:"application/json"}}).then(s=>{s.status===200||s.status===401?i.showToast("\u2705 Immich connection successful!",n.getAssetIDByName("ic_check")):i.showToast(`\u274C Connection failed: ${s.status}`,n.getAssetIDByName("ic_close_16px"))}).catch(s=>{i.showToast(`\u274C Cannot reach server: ${s.message}`,n.getAssetIDByName("ic_close_16px"))})},D=(r,o)=>{const s=y(),a=I();return!s||!a?(i.showToast("Immich not configured! Please set API key and server URL in settings.",n.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):(console.log("[ImmichSave] Starting upload for:",o),console.log("[ImmichSave] File URL:",r),console.log("[ImmichSave] Server URL:",a),console.log("[ImmichSave] API Key length:",s.length),fetch(r).then(e=>{if(console.log("[ImmichSave] File download response:",e.status,e.statusText),!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>(console.log("[ImmichSave] Downloaded blob size:",e.size,"bytes"),console.log("[ImmichSave] Blob type:",e.type),new Promise(t=>{const d=new FileReader;d.onload=function(l){const m=l.target?.result;if(!m||typeof m=="string"){t(e);return}const p=new Uint8Array(m),x=Array.from(p.slice(0,20)).map(u=>u.toString(16).padStart(2,"0")).join(" ");console.log("[ImmichSave] First 20 bytes (hex):",x);let w=0;for(let u=0;u<Math.min(100,p.length);u++)w=(w+p[u])%65536;console.log("[ImmichSave] Simple checksum (first 100 bytes):",w),t(e)},d.readAsArrayBuffer(e)}))).then(e=>{const t=new FormData,d=new File([e],o,{type:e.type||"application/octet-stream",lastModified:Date.now()});t.append("assetData",d);const l=o.match(/\d+/g)?.join("")||T();t.append("deviceAssetId",l),t.append("deviceId","discord");const m=new Date().toISOString();return t.append("fileCreatedAt",m),t.append("fileModifiedAt",m),t.append("fileSize",String(e.size)),t.append("isFavorite","false"),console.log("[ImmichSave] Uploading to:",`${a}/api/assets`),fetch(`${a}/api/assets`,{method:"POST",headers:{"x-api-key":s,Accept:"application/json"},body:t})}).then(e=>(console.log("[ImmichSave] Upload response status:",e.status,e.statusText),console.log("[ImmichSave] Upload response headers:",Object.fromEntries(e.headers.entries())),e.ok?e.text().then(t=>(console.log("[ImmichSave] Upload success response:",t),!0)):e.text().then(t=>{throw console.log("[ImmichSave] Upload error response body:",t),new Error(`Upload failed: ${e.status} - ${t}`)}))).catch(e=>{console.error("[ImmichSave] Upload error:",e),console.error("[ImmichSave] Error message:",e.message),console.error("[ImmichSave] Error type:",e.constructor.name),console.error("[ImmichSave] Error stack:",e.stack);let t="Unknown error occurred";return e.message.includes("Network request failed")?t="Cannot connect to Immich server. Check your server URL and network connection.":e.message.includes("Upload failed: 401")?t="Invalid API key. Please check your Immich API key in settings.":e.message.includes("Upload failed: 403")?t="Access denied. Check your API key permissions.":e.message.includes("Upload failed: 404")?t="Immich API endpoint not found. Check your server URL.":e.message.includes("Upload failed: 500")?t="Immich server error. Check server logs.":t=e.message||"Unknown error occurred",i.showToast(`Failed to save: ${t}`,n.getAssetIDByName("ic_close_16px")),!1}))},N=r=>{if(!U()){i.showToast("Please configure Immich settings first!",n.getAssetIDByName("ic_close_16px"));return}const o=r.attachments;if(!o||o.length===0){i.showToast("No media found in this message",n.getAssetIDByName("ic_close_16px"));return}const s=o.filter(l=>{const m=l.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(l.filename),p=l.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(l.filename);return m||p});if(s.length===0){i.showToast("No image or video attachments found",n.getAssetIDByName("ic_close_16px"));return}i.showToast(`Uploading ${s.length} file(s) to Immich...`,n.getAssetIDByName("ic_upload"));let a=0,e=0,t=0;const d=l=>D(l.url,l.filename).then(m=>{m?a++:e++,t++,s.length>1&&i.showToast(`Progress: ${t}/${s.length} files processed`,n.getAssetIDByName("ic_check")),t===s.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&i.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))}).catch(m=>{e++,t++,t===s.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&i.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))});s.forEach(l=>{d(l)})};var $={onLoad:()=>{F&&(S=R.before("render",F,r=>{try{const[o]=r,s=o.header?.props?.message;if(!s||!s.attachments?.some(a=>{const e=a.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.filename),t=a.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(a.filename);return e||t}))return;if(o.children&&Array.isArray(o.children)&&k&&!o.children.some(a=>a?.props?.label==="Save to Immich")){const a=c.React.createElement(k,{key:"save-to-immich",label:"Save to Immich",icon:n.getAssetIDByName("ic_download"),onPress:()=>{try{N(s)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),i.showToast(`Failed to save: ${e.message||"Unknown error"}`,n.getAssetIDByName("ic_close_16px"))}}});o.children.unshift(a)}}catch(o){console.error("[ImmichSave] ActionSheet patch error:",o)}}))},onUnload:()=>{S&&S()},settings:()=>{const[r,o]=c.React.useState(y()),[s,a]=c.React.useState(I()),e=()=>{P(r),i.showToast("API Key saved!",n.getAssetIDByName("ic_check"))},t=()=>{B(s),i.showToast("Server URL saved!",n.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(h.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(h.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),c.React.createElement(h.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:r,onChange:o,secureTextEntry:!0}),c.React.createElement(h.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(h.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:s,onChange:a}),c.React.createElement(h.Forms.FormRow,{label:"Save Server URL",onPress:t}),c.React.createElement(h.Forms.FormRow,{label:"Test Connection",onPress:E})),c.React.createElement(h.Forms.FormSection,{title:"Status"},c.React.createElement(h.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},U()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return v.default=$,Object.defineProperty(v,"__esModule",{value:!0}),v})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
