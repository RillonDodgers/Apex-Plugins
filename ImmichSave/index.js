(function(y,o,F,a,I,_,c,u){"use strict";const k={apiKey:"",serverUrl:""},v=()=>({...k,..._.storage}),b=e=>{Object.assign(_.storage,e)},N=e=>{const t=v();t.apiKey=e,b(t)},D=e=>{const t=v();t.serverUrl=e,b(t)},A=()=>v().apiKey,w=()=>v().serverUrl,B=()=>{const e=v();return e.apiKey.trim()!==""&&e.serverUrl.trim()!==""},m={IMAGE_EXTENSIONS:["jpg","jpeg","png","gif","webp","bmp","svg"],VIDEO_EXTENSIONS:["mp4","mov","avi","mkv","webm","m4v","3gp","flv","wmv"],isImageByContentType:e=>e?.startsWith("image/")||!1,isVideoByContentType:e=>e?.startsWith("video/")||!1,isImageByFilename:e=>{if(!e)return!1;const t=e.toLowerCase().split(".").pop();return m.IMAGE_EXTENSIONS.includes(t||"")},isVideoByFilename:e=>{if(!e)return!1;const t=e.toLowerCase().split(".").pop();return m.VIDEO_EXTENSIONS.includes(t||"")},isMediaAttachment:e=>{const t=m.isImageByContentType(e.content_type)||m.isImageByFilename(e.filename),r=m.isVideoByContentType(e.content_type)||m.isVideoByFilename(e.filename);return t||r},isMediaEmbed:e=>!!(e.image?.url||e.video?.url||e.thumbnail?.url||e.type==="image"||e.type==="video"||e.type==="gifv"),extractMediaFromEmbed:e=>{const t=[];if(e.image?.url){const r=e.image.url,i=m.generateFilenameFromUrl(r,"image");t.push({url:r,filename:i})}if(e.video?.url){const r=e.video.url,i=m.generateFilenameFromUrl(r,"video");t.push({url:r,filename:i})}if(t.length===0&&e.thumbnail?.url){const r=e.thumbnail.url,i=m.generateFilenameFromUrl(r,"thumbnail");t.push({url:r,filename:i})}return t},generateFilenameFromUrl:(e,t)=>{try{const r=new URL(e).pathname.split("/"),i=r[r.length-1];if(i&&i.includes("."))return i;const s=Date.now();return`${t}_${s}.${{image:"jpg",video:"mp4",thumbnail:"jpg"}[t]||"jpg"}`}catch{const r=Date.now();return`${t}_${r}.jpg`}}},f=I.findByProps("openLazy","hideActionSheet");I.findByProps("ActionSheet")?.ActionSheet;const T=I.findByProps("ActionSheetRow")?.ActionSheetRow;let S;const P=()=>{const e=A(),t=w();if(!e||!t){o.showToast("Immich not configured!",a.getAssetIDByName("ic_close_16px"));return}fetch(`${t}/api/albums`,{method:"GET",headers:{"X-API-KEY":e,Accept:"application/json"}}).then(r=>{r.status===200||r.status===401?o.showToast("\u2705 Immich connection successful!",a.getAssetIDByName("ic_check")):o.showToast(`\u274C Connection failed: ${r.status}`,a.getAssetIDByName("ic_close_16px"))}).catch(r=>{o.showToast(`\u274C Cannot reach server: ${r.message}`,a.getAssetIDByName("ic_close_16px"))})},R=(e,t)=>{const r=A(),i=w();if(!r||!i)return o.showToast("Immich not configured! Please set API key and server URL in settings.",a.getAssetIDByName("ic_close_16px")),Promise.resolve(!1);const s=new FormData,p=(n=>{switch(n.toLowerCase().split(".").pop()){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"webp":return"image/webp";case"bmp":return"image/bmp";case"svg":return"image/svg+xml";case"mp4":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";case"mkv":return"video/x-matroska";case"webm":return"video/webm";default:return"application/octet-stream"}})(t);s.append("assetData",{uri:e,name:t,type:p});const l=`${t.match(/\d+/g)?.join("")||""}-${Date.now()}`;s.append("deviceAssetId",l),s.append("deviceId","discord-mobile-v2");const d=new Date().toISOString();return s.append("fileCreatedAt",d),s.append("fileModifiedAt",d),fetch(`${i}/api/assets`,{method:"POST",headers:{"x-api-key":r,Accept:"application/json"},body:s}).then(n=>n.ok?n.text().then(()=>!0):n.text().then(h=>{throw console.error("[ImmichSave] Upload error response:",h),new Error(`Upload failed: ${n.status} - ${h}`)})).catch(n=>{console.error("[ImmichSave] Upload error:",n),console.error("[ImmichSave] Error message:",n.message),console.error("[ImmichSave] Error type:",n.constructor.name),console.error("[ImmichSave] Error stack:",n.stack);let h="Unknown error occurred";return n.message.includes("Network request failed")?h="Cannot connect to Immich server. Check your server URL and network connection.":n.message.includes("Upload failed: 401")?h="Invalid API key. Please check your Immich API key in settings.":n.message.includes("Upload failed: 403")?h="Access denied. Check your API key permissions.":n.message.includes("Upload failed: 404")?h="Immich API endpoint not found. Check your server URL.":n.message.includes("Upload failed: 500")?h="Immich server error. Check server logs.":h=n.message||"Unknown error occurred",o.showToast(`Failed to save: ${h}`,a.getAssetIDByName("ic_close_16px")),!1})},C=e=>{if(!B()){o.showToast("Please configure Immich settings first!",a.getAssetIDByName("ic_close_16px"));return}const t=[];if(e.attachments&&e.attachments.length>0&&e.attachments.filter(m.isMediaAttachment).forEach(l=>{t.push({url:l.url,filename:l.filename})}),e.embeds&&e.embeds.length>0&&e.embeds.forEach(l=>{if(m.isMediaEmbed(l)){const d=m.extractMediaFromEmbed(l);t.push(...d)}}),t.length===0){o.showToast("No media found in this message",a.getAssetIDByName("ic_close_16px"));return}o.showToast(`Uploading ${t.length} file(s) to Immich...`,a.getAssetIDByName("ic_upload"));let r=0,i=0,s=0;const p=l=>R(l.url,l.filename).then(d=>{d?r++:i++,s++,t.length>1&&o.showToast(`Progress: ${s}/${t.length} files processed`,a.getAssetIDByName("ic_check")),s===t.length&&(r>0&&o.showToast(`Successfully saved ${r} file(s) to Immich!`,a.getAssetIDByName("ic_check")),i>0&&o.showToast(`Failed to save ${i} file(s)`,a.getAssetIDByName("ic_close_16px")))}).catch(d=>{i++,s++,s===t.length&&(r>0&&o.showToast(`Successfully saved ${r} file(s) to Immich!`,a.getAssetIDByName("ic_check")),i>0&&o.showToast(`Failed to save ${i} file(s)`,a.getAssetIDByName("ic_close_16px")))});t.forEach(l=>{p(l)})};var $={onLoad:()=>{f&&(S=F.before("openLazy",f,e=>{const[t,r,i]=e;r==="MessageLongPressActionSheet"&&t.then(s=>{const p=F.before("default",s,l=>{const[d]=l;try{const[n,h]=d.props?.children?.props?.children?.props?.children;let g;if(n?g=n.props.message:g=i.message,!g||!h)return;const x=g.attachments?.some(m.isMediaAttachment),L=g.embeds?.some(m.isMediaEmbed);if(!x&&!L)return;if(!h.some(E=>E?.props?.label==="Save to Immich")&&T){const E=c.React.createElement(T,{key:"save-to-immich",label:"Save to Immich",icon:a.getAssetIDByName("ic_download"),onPress:()=>{try{f?.hideActionSheet&&f.hideActionSheet(),C(g)}catch(U){console.error("[ImmichSave] Error in Save to Immich handler:",U),o.showToast(`Failed to save: ${U.message||"Unknown error"}`,a.getAssetIDByName("ic_close_16px"))}}});d.props.children.props.children.props.children[1]=[E,...h]}p()}catch(n){console.error("[ImmichSave] ActionSheet patch error:",n)}})})}))},onUnload:()=>{S&&S()},settings:()=>{const[e,t]=c.React.useState(A()),[r,i]=c.React.useState(w()),s=()=>{N(e),o.showToast("API Key saved!",a.getAssetIDByName("ic_check"))},p=()=>{D(r),o.showToast("Server URL saved!",a.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(u.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(u.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),c.React.createElement(u.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:e,onChange:t,secureTextEntry:!0}),c.React.createElement(u.Forms.FormRow,{label:"Save API Key",onPress:s}),c.React.createElement(u.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:r,onChange:i}),c.React.createElement(u.Forms.FormRow,{label:"Save Server URL",onPress:p}),c.React.createElement(u.Forms.FormRow,{label:"Test Connection",onPress:P})),c.React.createElement(u.Forms.FormSection,{title:"Status"},c.React.createElement(u.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},B()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return y.default=$,Object.defineProperty(y,"__esModule",{value:!0}),y})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
