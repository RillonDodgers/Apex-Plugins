(function(v,s,k,n,y,S,d,p){"use strict";const B={apiKey:"",serverUrl:""},g=()=>({...B,...S.storage}),w=e=>{Object.assign(S.storage,e)},T=e=>{const t=g();t.apiKey=e,w(t)},U=e=>{const t=g();t.serverUrl=e,w(t)},f=()=>g().apiKey,I=()=>g().serverUrl,b=()=>{const e=g();return e.apiKey.trim()!==""&&e.serverUrl.trim()!==""},h={IMAGE_EXTENSIONS:["jpg","jpeg","png","gif","webp","bmp","svg"],VIDEO_EXTENSIONS:["mp4","mov","avi","mkv","webm","m4v","3gp","flv","wmv"],isImageByContentType:e=>e?.startsWith("image/")||!1,isVideoByContentType:e=>e?.startsWith("video/")||!1,isImageByFilename:e=>{if(!e)return!1;const t=e.toLowerCase().split(".").pop();return h.IMAGE_EXTENSIONS.includes(t||"")},isVideoByFilename:e=>{if(!e)return!1;const t=e.toLowerCase().split(".").pop();return h.VIDEO_EXTENSIONS.includes(t||"")},isMediaAttachment:e=>{const t=h.isImageByContentType(e.content_type)||h.isImageByFilename(e.filename),r=h.isVideoByContentType(e.content_type)||h.isVideoByFilename(e.filename);return t||r},isMediaEmbed:e=>!!(e.image?.url||e.video?.url||e.thumbnail?.url||e.type==="image"||e.type==="video"||e.type==="gifv"),extractMediaFromEmbed:e=>{const t=[];if(e.image?.url){const r=e.image.url,a=h.generateFilenameFromUrl(r,"image");t.push({url:r,filename:a})}if(e.video?.url){const r=e.video.url,a=h.generateFilenameFromUrl(r,"video");t.push({url:r,filename:a})}if(t.length===0&&e.thumbnail?.url){const r=e.thumbnail.url,a=h.generateFilenameFromUrl(r,"thumbnail");t.push({url:r,filename:a})}return t},generateFilenameFromUrl:(e,t)=>{try{const r=new URL(e).pathname.split("/"),a=r[r.length-1];if(a&&a.includes("."))return a;const o=Date.now();return`${t}_${o}.${{image:"jpg",video:"mp4",thumbnail:"jpg"}[t]||"jpg"}`}catch{const r=Date.now();return`${t}_${r}.jpg`}}},E=y.findByProps("openLazy","hideActionSheet"),_=y.findByProps("ActionSheet")?.ActionSheet,F=y.findByProps("ActionSheetRow")?.ActionSheetRow;let A;const C=()=>{const e=f(),t=I();if(!e||!t){s.showToast("Immich not configured!",n.getAssetIDByName("ic_close_16px"));return}fetch(`${t}/api/albums`,{method:"GET",headers:{"X-API-KEY":e,Accept:"application/json"}}).then(r=>{r.status===200||r.status===401?s.showToast("\u2705 Immich connection successful!",n.getAssetIDByName("ic_check")):s.showToast(`\u274C Connection failed: ${r.status}`,n.getAssetIDByName("ic_close_16px"))}).catch(r=>{s.showToast(`\u274C Cannot reach server: ${r.message}`,n.getAssetIDByName("ic_close_16px"))})},N=(e,t)=>{const r=f(),a=I();if(!r||!a)return s.showToast("Immich not configured! Please set API key and server URL in settings.",n.getAssetIDByName("ic_close_16px")),Promise.resolve(!1);const o=new FormData,u=(i=>{switch(i.toLowerCase().split(".").pop()){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"webp":return"image/webp";case"bmp":return"image/bmp";case"svg":return"image/svg+xml";case"mp4":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";case"mkv":return"video/x-matroska";case"webm":return"video/webm";default:return"application/octet-stream"}})(t);o.append("assetData",{uri:e,name:t,type:u});const c=`${t.match(/\d+/g)?.join("")||""}-${Date.now()}`;o.append("deviceAssetId",c),o.append("deviceId","discord-mobile-v2");const l=new Date().toISOString();return o.append("fileCreatedAt",l),o.append("fileModifiedAt",l),fetch(`${a}/api/assets`,{method:"POST",headers:{"x-api-key":r,Accept:"application/json"},body:o}).then(i=>i.ok?i.text().then(()=>!0):i.text().then(m=>{throw console.error("[ImmichSave] Upload error response:",m),new Error(`Upload failed: ${i.status} - ${m}`)})).catch(i=>{console.error("[ImmichSave] Upload error:",i),console.error("[ImmichSave] Error message:",i.message),console.error("[ImmichSave] Error type:",i.constructor.name),console.error("[ImmichSave] Error stack:",i.stack);let m="Unknown error occurred";return i.message.includes("Network request failed")?m="Cannot connect to Immich server. Check your server URL and network connection.":i.message.includes("Upload failed: 401")?m="Invalid API key. Please check your Immich API key in settings.":i.message.includes("Upload failed: 403")?m="Access denied. Check your API key permissions.":i.message.includes("Upload failed: 404")?m="Immich API endpoint not found. Check your server URL.":i.message.includes("Upload failed: 500")?m="Immich server error. Check server logs.":m=i.message||"Unknown error occurred",s.showToast(`Failed to save: ${m}`,n.getAssetIDByName("ic_close_16px")),!1})},D=e=>{if(!b()){s.showToast("Please configure Immich settings first!",n.getAssetIDByName("ic_close_16px"));return}const t=[];if(e.attachments&&e.attachments.length>0&&e.attachments.filter(h.isMediaAttachment).forEach(c=>{t.push({url:c.url,filename:c.filename})}),e.embeds&&e.embeds.length>0&&e.embeds.forEach(c=>{if(h.isMediaEmbed(c)){const l=h.extractMediaFromEmbed(c);t.push(...l)}}),t.length===0){s.showToast("No media found in this message",n.getAssetIDByName("ic_close_16px"));return}s.showToast(`Uploading ${t.length} file(s) to Immich...`,n.getAssetIDByName("ic_upload"));let r=0,a=0,o=0;const u=c=>N(c.url,c.filename).then(l=>{l?r++:a++,o++,t.length>1&&s.showToast(`Progress: ${o}/${t.length} files processed`,n.getAssetIDByName("ic_check")),o===t.length&&(r>0&&s.showToast(`Successfully saved ${r} file(s) to Immich!`,n.getAssetIDByName("ic_check")),a>0&&s.showToast(`Failed to save ${a} file(s)`,n.getAssetIDByName("ic_close_16px")))}).catch(l=>{a++,o++,o===t.length&&(r>0&&s.showToast(`Successfully saved ${r} file(s) to Immich!`,n.getAssetIDByName("ic_check")),a>0&&s.showToast(`Failed to save ${a} file(s)`,n.getAssetIDByName("ic_close_16px")))});t.forEach(c=>{u(c)})};var R={onLoad:()=>{_&&(A=k.before("render",_,e=>{try{const[t]=e,r=t.header?.props?.message;if(!r)return;const a=r.attachments?.some(h.isMediaAttachment),o=r.embeds?.some(h.isMediaEmbed);if(!a&&!o)return;if(t.children&&Array.isArray(t.children)&&F){let u=-1,c=null;for(let l=0;l<t.children.length;l++){const i=t.children[l];if(i?.props?.children&&Array.isArray(i.props.children)&&i.props.children.some(m=>m?.props?.label==="Save Image"||m?.props?.label==="Save Video"||m?.props?.label==="Copy Media Link"||m?.props?.label==="Copy Message Link"||m?.props?.label==="Copy Message ID")){u=l,c=i;break}}if(c&&u>=0&&!c.props.children.some(l=>l?.props?.label==="Save to Immich")){const l=d.React.createElement(F,{key:"save-to-immich",label:"Save to Immich",icon:n.getAssetIDByName("ic_image"),onPress:()=>{try{E?.hideActionSheet&&E.hideActionSheet(),D(r)}catch(i){console.error("[ImmichSave] Error in Save to Immich handler:",i),s.showToast(`Failed to save: ${i.message||"Unknown error"}`,n.getAssetIDByName("ic_close_16px"))}}});c.props.children.unshift(l)}}}catch(t){console.error("[ImmichSave] ActionSheet patch error:",t)}}))},onUnload:()=>{A&&A()},settings:()=>{const[e,t]=d.React.useState(f()),[r,a]=d.React.useState(I()),o=()=>{T(e),s.showToast("API Key saved!",n.getAssetIDByName("ic_check"))},u=()=>{U(r),s.showToast("Server URL saved!",n.getAssetIDByName("ic_check"))};return d.React.createElement(d.React.Fragment,null,d.React.createElement(p.Forms.FormSection,{title:"Immich Configuration"},d.React.createElement(p.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),d.React.createElement(p.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:e,onChange:t,secureTextEntry:!0}),d.React.createElement(p.Forms.FormRow,{label:"Save API Key",onPress:o}),d.React.createElement(p.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:r,onChange:a}),d.React.createElement(p.Forms.FormRow,{label:"Save Server URL",onPress:u}),d.React.createElement(p.Forms.FormRow,{label:"Test Connection",onPress:C})),d.React.createElement(p.Forms.FormSection,{title:"Status"},d.React.createElement(p.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},b()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return v.default=R,Object.defineProperty(v,"__esModule",{value:!0}),v})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
