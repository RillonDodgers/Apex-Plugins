(function(u,n,R,s,p,w,i,d){"use strict";const b={apiKey:"",serverUrl:""},g=()=>({...b,...w.storage}),A=a=>{Object.assign(w.storage,a)},B=a=>{const e=g();e.apiKey=a,A(e)},F=a=>{const e=g();e.serverUrl=a,A(e)},v=()=>g().apiKey,f=()=>g().serverUrl,S=()=>{const a=g();return a.apiKey.trim()!==""&&a.serverUrl.trim()!==""},_=p.findByProps("openLazy","hideActionSheet"),k=p.findByProps("ActionSheet")?.ActionSheet,P=p.findByProps("ActionSheetRow")?.ActionSheetRow;let y;const T=()=>{const a=v(),e=f();if(!a||!e){n.showToast("Immich not configured!",s.getAssetIDByName("ic_close_16px"));return}fetch(`${e}/api/albums`,{method:"GET",headers:{"X-API-KEY":a,Accept:"application/json"}}).then(t=>{t.status===200||t.status===401?n.showToast("\u2705 Immich connection successful!",s.getAssetIDByName("ic_check")):n.showToast(`\u274C Connection failed: ${t.status}`,s.getAssetIDByName("ic_close_16px"))}).catch(t=>{n.showToast(`\u274C Cannot reach server: ${t.message}`,s.getAssetIDByName("ic_close_16px"))})},U=(a,e)=>{const t=v(),c=f();if(!t||!c)return n.showToast("Immich not configured! Please set API key and server URL in settings.",s.getAssetIDByName("ic_close_16px")),Promise.resolve(!1);const o=new FormData,h=(r=>{switch(r.toLowerCase().split(".").pop()){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"webp":return"image/webp";case"bmp":return"image/bmp";case"svg":return"image/svg+xml";case"mp4":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";case"mkv":return"video/x-matroska";case"webm":return"video/webm";default:return"application/octet-stream"}})(e);o.append("assetData",{uri:a,name:e,type:h});const I=`${e.match(/\d+/g)?.join("")||""}-${Date.now()}`;o.append("deviceAssetId",I),o.append("deviceId","discord-mobile-v2");const m=new Date().toISOString();return o.append("fileCreatedAt",m),o.append("fileModifiedAt",m),fetch(`${c}/api/assets`,{method:"POST",headers:{"x-api-key":t,Accept:"application/json"},body:o}).then(r=>r.ok?r.text().then(()=>!0):r.text().then(l=>{throw console.error("[ImmichSave] Upload error response:",l),new Error(`Upload failed: ${r.status} - ${l}`)})).catch(r=>{console.error("[ImmichSave] Upload error:",r),console.error("[ImmichSave] Error message:",r.message),console.error("[ImmichSave] Error type:",r.constructor.name),console.error("[ImmichSave] Error stack:",r.stack);let l="Unknown error occurred";return r.message.includes("Network request failed")?l="Cannot connect to Immich server. Check your server URL and network connection.":r.message.includes("Upload failed: 401")?l="Invalid API key. Please check your Immich API key in settings.":r.message.includes("Upload failed: 403")?l="Access denied. Check your API key permissions.":r.message.includes("Upload failed: 404")?l="Immich API endpoint not found. Check your server URL.":r.message.includes("Upload failed: 500")?l="Immich server error. Check server logs.":l=r.message||"Unknown error occurred",n.showToast(`Failed to save: ${l}`,s.getAssetIDByName("ic_close_16px")),!1})},D=a=>{if(!S()){n.showToast("Please configure Immich settings first!",s.getAssetIDByName("ic_close_16px"));return}const e=a.attachments;if(!e||e.length===0){n.showToast("No media found in this message",s.getAssetIDByName("ic_close_16px"));return}const t=e.filter(m=>{const r=m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(m.filename),l=m.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(m.filename);return r||l});if(t.length===0){n.showToast("No image or video attachments found",s.getAssetIDByName("ic_close_16px"));return}n.showToast(`Uploading ${t.length} file(s) to Immich...`,s.getAssetIDByName("ic_upload"));let c=0,o=0,h=0;const I=m=>U(m.url,m.filename).then(r=>{r?c++:o++,h++,t.length>1&&n.showToast(`Progress: ${h}/${t.length} files processed`,s.getAssetIDByName("ic_check")),h===t.length&&(c>0&&n.showToast(`Successfully saved ${c} file(s) to Immich!`,s.getAssetIDByName("ic_check")),o>0&&n.showToast(`Failed to save ${o} file(s)`,s.getAssetIDByName("ic_close_16px")))}).catch(r=>{o++,h++,h===t.length&&(c>0&&n.showToast(`Successfully saved ${c} file(s) to Immich!`,s.getAssetIDByName("ic_check")),o>0&&n.showToast(`Failed to save ${o} file(s)`,s.getAssetIDByName("ic_close_16px")))});t.forEach(m=>{I(m)})};var E={onLoad:()=>{k&&(y=R.before("render",k,a=>{try{const[e]=a,t=e.header?.props?.message;if(!t||!t.attachments?.some(c=>{const o=c.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(c.filename),h=c.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(c.filename);return o||h}))return;if(e.children&&Array.isArray(e.children)&&P&&!e.children.some(c=>c?.props?.label==="Save to Immich")){const c=i.React.createElement(P,{key:"save-to-immich",label:"Save to Immich",icon:s.getAssetIDByName("ic_download"),onPress:()=>{try{_?.hideActionSheet&&_.hideActionSheet(),D(t)}catch(o){console.error("[ImmichSave] Error in Save to Immich handler:",o),n.showToast(`Failed to save: ${o.message||"Unknown error"}`,s.getAssetIDByName("ic_close_16px"))}}});e.children.unshift(c)}}catch(e){console.error("[ImmichSave] ActionSheet patch error:",e)}}))},onUnload:()=>{y&&y()},settings:()=>{const[a,e]=i.React.useState(v()),[t,c]=i.React.useState(f()),o=()=>{B(a),n.showToast("API Key saved!",s.getAssetIDByName("ic_check"))},h=()=>{F(t),n.showToast("Server URL saved!",s.getAssetIDByName("ic_check"))};return i.React.createElement(i.React.Fragment,null,i.React.createElement(d.Forms.FormSection,{title:"Immich Configuration"},i.React.createElement(d.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),i.React.createElement(d.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:a,onChange:e,secureTextEntry:!0}),i.React.createElement(d.Forms.FormRow,{label:"Save API Key",onPress:o}),i.React.createElement(d.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:t,onChange:c}),i.React.createElement(d.Forms.FormRow,{label:"Save Server URL",onPress:h}),i.React.createElement(d.Forms.FormRow,{label:"Test Connection",onPress:T})),i.React.createElement(d.Forms.FormSection,{title:"Status"},i.React.createElement(d.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},S()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return u.default=E,Object.defineProperty(u,"__esModule",{value:!0}),u})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
