(function(h,g,i,c,f,n,l,S,_){"use strict";const A={apiKey:"",serverUrl:""},d=()=>({...A,...f.storage}),y=e=>{Object.assign(f.storage,e)},F=e=>{const a=d();a.apiKey=e,y(a)},R=e=>{const a=d();a.serverUrl=e,y(a)},v=()=>d().apiKey,I=()=>d().serverUrl,w=()=>{const e=d();return e.apiKey.trim()!==""&&e.serverUrl.trim()!==""};let p=[];const E=()=>{g.findByStoreName("ChannelStore"),g.findByStoreName("MessageStore")},b=async(e,a)=>{const s=v(),o=I();if(!s||!o)return i.showToast("Immich not configured! Please set API key and server URL in settings.",c.getAssetIDByName("ic_close_16px")),!1;try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.status}`);const r=await t.blob(),m=new FormData;m.append("assetData",r,a),m.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),m.append("deviceId","vendetta-discord"),m.append("fileCreatedAt",new Date().toISOString()),m.append("fileModifiedAt",new Date().toISOString());const u=await fetch(`${o}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":s},body:m});if(!u.ok){const D=await u.text();throw new Error(`Upload failed: ${u.status} - ${D}`)}return!0}catch(t){return console.error("Immich upload error:",t),i.showToast(`Upload failed: ${t.message}`,c.getAssetIDByName("ic_close_16px")),!1}},P=async e=>{if(!w()){i.showToast("Please configure Immich settings first!",c.getAssetIDByName("ic_close_16px"));return}const a=e.attachments;if(!a||a.length===0){i.showToast("No images found in this message",c.getAssetIDByName("ic_close_16px"));return}const s=a.filter(r=>r.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(r.filename));if(s.length===0){i.showToast("No image attachments found",c.getAssetIDByName("ic_close_16px"));return}let o=0,t=0;for(const r of s)await b(r.url,r.filename)?o++:t++;o>0&&i.showToast(`Successfully saved ${o} image(s) to Immich!`,c.getAssetIDByName("ic_check")),t>0&&i.showToast(`Failed to save ${t} image(s)`,c.getAssetIDByName("ic_close_16px"))};var B={onLoad:()=>{E();const e=S.before("render",g.findByProps("ScrollView").View,a=>{try{let s=_.findInReactTree(a,r=>r.key===".$MessageOverflow");if(!s||!s.props||s.props.sheetKey!=="MessageOverflow")return;const o=s.props.content.props;if(!o.options||o.options.some(r=>r?.label==="Save to Immich"))return;const t=s.props.message;if(!t||!t.attachments||t.attachments.length===0||!t.attachments.some(r=>r.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(r.filename)))return;o.options.unshift({label:"Save to Immich",onPress:()=>{try{P(t),o.hideActionSheet()}catch(r){console.error("Error saving to Immich:",r),i.showToast("Failed to save images to Immich",c.getAssetIDByName("ic_close_16px"))}}})}catch(s){console.error("Context menu patch error:",s)}});p.push(e)},onUnload:()=>{p.forEach(e=>{try{e()}catch(a){console.error("Error unpatching:",a)}}),p=[]},settings:()=>{const[e,a]=n.React.useState(v()),[s,o]=n.React.useState(I()),t=()=>{F(e),i.showToast("API Key saved!",c.getAssetIDByName("ic_check"))},r=()=>{R(s),i.showToast("Server URL saved!",c.getAssetIDByName("ic_check"))};return n.React.createElement(n.React.Fragment,null,n.React.createElement(l.Forms.FormSection,{title:"Immich Configuration"},n.React.createElement(l.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),n.React.createElement(l.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:e,onChange:a,secureTextEntry:!0}),n.React.createElement(l.Forms.FormRow,{label:"Save API Key",onPress:t}),n.React.createElement(l.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:s,onChange:o}),n.React.createElement(l.Forms.FormRow,{label:"Save Server URL",onPress:r})),n.React.createElement(l.Forms.FormSection,{title:"Status"},n.React.createElement(l.Forms.FormText,{style:{marginBottom:10}},w()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return h.default=B,Object.defineProperty(h,"__esModule",{value:!0}),h})({},vendetta.metro,vendetta.ui.toasts,vendetta.ui.assets,vendetta.plugin,vendetta.metro.common,vendetta.ui.components,vendetta.patcher,vendetta.utils);
