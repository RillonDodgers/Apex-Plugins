(function(g,s,_,n,v,u,c,m){"use strict";const F={apiKey:"",serverUrl:""},h=()=>({...F,...u.storage}),f=o=>{Object.assign(u.storage,o)},R=o=>{const t=h();t.apiKey=o,f(t)},b=o=>{const t=h();t.serverUrl=o,f(t)},y=()=>h().apiKey,I=()=>h().serverUrl,w=()=>{const o=h();return o.apiKey.trim()!==""&&o.serverUrl.trim()!==""};v.findByProps("openLazy","hideActionSheet");const S=v.findByProps("ActionSheet")?.ActionSheet,A=v.findByProps("ActionSheetRow")?.ActionSheetRow;let p;const B=(o,t)=>{const i=y(),a=I();return!i||!a?(s.showToast("Immich not configured! Please set API key and server URL in settings.",n.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(o).then(e=>{if(!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>{const r=new FormData;return r.append("assetData",e,t),r.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),r.append("deviceId","vendetta-discord"),r.append("fileCreatedAt",new Date().toISOString()),r.append("fileModifiedAt",new Date().toISOString()),fetch(`${a}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":i},body:r})}).then(e=>e.ok?!0:e.text().then(r=>{throw new Error(`Upload failed: ${e.status} - ${r}`)})).catch(e=>{console.error("[ImmichSave] Upload error:",e);const r=e.message||"Unknown error occurred";return s.showToast(`Failed to save: ${r}`,n.getAssetIDByName("ic_close_16px")),!1})},D=o=>{if(!w()){s.showToast("Please configure Immich settings first!",n.getAssetIDByName("ic_close_16px"));return}const t=o.attachments;if(!t||t.length===0){s.showToast("No media found in this message",n.getAssetIDByName("ic_close_16px"));return}const i=t.filter(l=>{const d=l.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(l.filename),P=l.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(l.filename);return d||P});if(i.length===0){s.showToast("No image or video attachments found",n.getAssetIDByName("ic_close_16px"));return}s.showToast(`Uploading ${i.length} file(s) to Immich...`,n.getAssetIDByName("ic_upload"));let a=0,e=0,r=0;const E=l=>B(l.url,l.filename).then(d=>{d?a++:e++,r++,i.length>1&&s.showToast(`Progress: ${r}/${i.length} files processed`,n.getAssetIDByName("ic_check")),r===i.length&&(a>0&&s.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))}).catch(d=>{e++,r++,r===i.length&&(a>0&&s.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&s.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))});i.forEach(l=>{E(l)})};var $={onLoad:()=>{S&&(p=_.before("render",S,o=>{try{const[t]=o,i=t.header?.props?.message;if(!i||!i.attachments?.some(a=>{const e=a.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.filename),r=a.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(a.filename);return e||r}))return;if(t.children&&Array.isArray(t.children)&&A&&!t.children.some(a=>a?.props?.label==="Save to Immich")){const a=c.React.createElement(A,{key:"save-to-immich",label:"Save to Immich",icon:n.getAssetIDByName("ic_download"),onPress:()=>{try{D(i)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),s.showToast(`Failed to save: ${e.message||"Unknown error"}`,n.getAssetIDByName("ic_close_16px"))}}});t.children.unshift(a)}}catch(t){console.error("[ImmichSave] ActionSheet patch error:",t)}}))},onUnload:()=>{p&&p()},settings:()=>{const[o,t]=c.React.useState(y()),[i,a]=c.React.useState(I()),e=()=>{R(o),s.showToast("API Key saved!",n.getAssetIDByName("ic_check"))},r=()=>{b(i),s.showToast("Server URL saved!",n.getAssetIDByName("ic_check"))};return c.React.createElement(c.React.Fragment,null,c.React.createElement(m.Forms.FormSection,{title:"Immich Configuration"},c.React.createElement(m.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),c.React.createElement(m.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:o,onChange:t,secureTextEntry:!0}),c.React.createElement(m.Forms.FormRow,{label:"Save API Key",onPress:e}),c.React.createElement(m.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:i,onChange:a}),c.React.createElement(m.Forms.FormRow,{label:"Save Server URL",onPress:r})),c.React.createElement(m.Forms.FormSection,{title:"Status"},c.React.createElement(m.Forms.FormText,{style:{marginBottom:10}},w()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=$,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
