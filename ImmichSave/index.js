(function(g,i,_,n,p,f,s,l){"use strict";const k={apiKey:"",serverUrl:""},h=()=>({...k,...f.storage}),y=c=>{Object.assign(f.storage,c)},T=c=>{const t=h();t.apiKey=c,y(t)},D=c=>{const t=h();t.serverUrl=c,y(t)},u=()=>h().apiKey,v=()=>h().serverUrl,A=()=>{const c=h();return c.apiKey.trim()!==""&&c.serverUrl.trim()!==""};p.findByProps("openLazy","hideActionSheet");const S=p.findByProps("ActionSheet")?.ActionSheet,w=p.findByProps("ActionSheetRow")?.ActionSheetRow;let I;const P=()=>{const c=u(),t=v();if(!c||!t){i.showToast("Immich not configured!",n.getAssetIDByName("ic_close_16px"));return}console.log("[ImmichSave] Testing connection to:",`${t}/api/albums`),fetch(`${t}/api/albums`,{method:"GET",headers:{"X-API-KEY":c,"User-Agent":"Discord-Mobile/1.0",Accept:"application/json","Cache-Control":"no-cache"},mode:"cors",credentials:"omit"}).then(r=>{console.log("[ImmichSave] Connection test response:",r.status,r.statusText),r.ok?i.showToast("\u2705 Immich connection successful!",n.getAssetIDByName("ic_check")):i.showToast(`\u274C Connection failed: ${r.status}`,n.getAssetIDByName("ic_close_16px"))}).catch(r=>{console.error("[ImmichSave] Primary connection test failed:",r),console.log("[ImmichSave] Trying simpler connection test to:",t),fetch(t,{method:"GET",mode:"no-cors"}).then(a=>{console.log("[ImmichSave] Simple test response:",a.type,a.status),i.showToast("\u2705 Server reachable (no-cors mode)",n.getAssetIDByName("ic_check"))}).catch(a=>{console.error("[ImmichSave] All connection tests failed:",a),i.showToast(`\u274C Cannot reach server: ${r.message}`,n.getAssetIDByName("ic_close_16px"))})})},B=(c,t)=>{const r=u(),a=v();return!r||!a?(i.showToast("Immich not configured! Please set API key and server URL in settings.",n.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):fetch(c).then(e=>{if(!e.ok)throw new Error(`Failed to download file: ${e.status}`);return e.blob()}).then(e=>{const o=new FormData;return o.append("assetData",e,t),o.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),o.append("deviceId","vendetta-discord"),o.append("fileCreatedAt",new Date().toISOString()),o.append("fileModifiedAt",new Date().toISOString()),o.append("filename",t),o.append("metadata",JSON.stringify([])),console.log("[ImmichSave] Uploading to Immich:",`${a}/api/asset/upload`),console.log("[ImmichSave] API Key length:",r.length),console.log("[ImmichSave] FormData prepared with keys:",["assetData","deviceAssetId","deviceId","fileCreatedAt","fileModifiedAt","filename","metadata"]),console.log("[ImmichSave] Blob size:",e.size,"bytes"),fetch(`${a}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":r},body:o})}).then(e=>e.ok?!0:e.text().then(o=>{throw new Error(`Upload failed: ${e.status} - ${o}`)})).catch(e=>{console.error("[ImmichSave] Upload error:",e),console.error("[ImmichSave] Error type:",e.constructor.name),console.error("[ImmichSave] Error stack:",e.stack);let o="Unknown error occurred";return e.message.includes("Network request failed")?o="Cannot connect to Immich server. Check your server URL and network connection.":e.message.includes("Upload failed: 401")?o="Invalid API key. Please check your Immich API key in settings.":e.message.includes("Upload failed: 403")?o="Access denied. Check your API key permissions.":e.message.includes("Upload failed: 404")?o="Immich API endpoint not found. Check your server URL.":e.message.includes("Upload failed: 500")?o="Immich server error. Check server logs.":o=e.message||"Unknown error occurred",i.showToast(`Failed to save: ${o}`,n.getAssetIDByName("ic_close_16px")),!1})},E=c=>{if(!A()){i.showToast("Please configure Immich settings first!",n.getAssetIDByName("ic_close_16px"));return}const t=c.attachments;if(!t||t.length===0){i.showToast("No media found in this message",n.getAssetIDByName("ic_close_16px"));return}const r=t.filter(m=>{const d=m.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(m.filename),b=m.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(m.filename);return d||b});if(r.length===0){i.showToast("No image or video attachments found",n.getAssetIDByName("ic_close_16px"));return}i.showToast(`Uploading ${r.length} file(s) to Immich...`,n.getAssetIDByName("ic_upload"));let a=0,e=0,o=0;const U=m=>B(m.url,m.filename).then(d=>{d?a++:e++,o++,r.length>1&&i.showToast(`Progress: ${o}/${r.length} files processed`,n.getAssetIDByName("ic_check")),o===r.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&i.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))}).catch(d=>{e++,o++,o===r.length&&(a>0&&i.showToast(`Successfully saved ${a} file(s) to Immich!`,n.getAssetIDByName("ic_check")),e>0&&i.showToast(`Failed to save ${e} file(s)`,n.getAssetIDByName("ic_close_16px")))});r.forEach(m=>{U(m)})};var F={onLoad:()=>{S&&(I=_.before("render",S,c=>{try{const[t]=c,r=t.header?.props?.message;if(!r||!r.attachments?.some(a=>{const e=a.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.filename),o=a.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(a.filename);return e||o}))return;if(t.children&&Array.isArray(t.children)&&w&&!t.children.some(a=>a?.props?.label==="Save to Immich")){const a=s.React.createElement(w,{key:"save-to-immich",label:"Save to Immich",icon:n.getAssetIDByName("ic_download"),onPress:()=>{try{E(r)}catch(e){console.error("[ImmichSave] Error in Save to Immich handler:",e),i.showToast(`Failed to save: ${e.message||"Unknown error"}`,n.getAssetIDByName("ic_close_16px"))}}});t.children.unshift(a)}}catch(t){console.error("[ImmichSave] ActionSheet patch error:",t)}}))},onUnload:()=>{I&&I()},settings:()=>{const[c,t]=s.React.useState(u()),[r,a]=s.React.useState(v()),e=()=>{T(c),i.showToast("API Key saved!",n.getAssetIDByName("ic_check"))},o=()=>{D(r),i.showToast("Server URL saved!",n.getAssetIDByName("ic_check"))};return s.React.createElement(s.React.Fragment,null,s.React.createElement(l.Forms.FormSection,{title:"Immich Configuration"},s.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},"Configure your Immich server connection:"),s.React.createElement(l.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:c,onChange:t,secureTextEntry:!0}),s.React.createElement(l.Forms.FormRow,{label:"Save API Key",onPress:e}),s.React.createElement(l.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:r,onChange:a}),s.React.createElement(l.Forms.FormRow,{label:"Save Server URL",onPress:o}),s.React.createElement(l.Forms.FormRow,{label:"Test Connection",onPress:P})),s.React.createElement(l.Forms.FormSection,{title:"Status"},s.React.createElement(l.Forms.FormText,{style:{marginBottom:10,marginLeft:10}},A()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=F,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
