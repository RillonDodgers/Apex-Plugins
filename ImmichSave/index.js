(function(g,c,_,r,p,I,s,h){"use strict";const R={apiKey:"",serverUrl:""},m=()=>({...R,...I.storage}),S=n=>{Object.assign(I.storage,n)},F=n=>{const e=m();e.apiKey=n,S(e)},b=n=>{const e=m();e.serverUrl=n,S(e)},y=()=>m().apiKey,f=()=>m().serverUrl,A=()=>{const n=m();return n.apiKey.trim()!==""&&n.serverUrl.trim()!==""};p.findByProps("openLazy","hideActionSheet");const w=p.findByProps("ActionSheet")?.ActionSheet,v=p.findByProps("ActionSheetRow")?.ActionSheetRow;let u;const D=(n,e)=>{const i=y(),o=f();return!i||!o?(c.showToast("Immich not configured! Please set API key and server URL in settings.",r.getAssetIDByName("ic_close_16px")),Promise.resolve(!1)):(console.log("[ImmichSave] Downloading file:",n),fetch(n).then(t=>{if(!t.ok)throw new Error(`Failed to download file: ${t.status}`);return t.blob()}).then(t=>{console.log("[ImmichSave] Downloaded blob size:",t.size);const a=new FormData;return a.append("assetData",t,e),a.append("deviceAssetId",`discord_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),a.append("deviceId","vendetta-discord"),a.append("fileCreatedAt",new Date().toISOString()),a.append("fileModifiedAt",new Date().toISOString()),console.log("[ImmichSave] Uploading to Immich:",`${o}/api/asset/upload`),fetch(`${o}/api/asset/upload`,{method:"POST",headers:{"X-API-KEY":i},body:a})}).then(t=>t.ok?(console.log("[ImmichSave] Upload successful"),!0):t.text().then(a=>{throw new Error(`Upload failed: ${t.status} - ${a}`)})).catch(t=>(console.error("[ImmichSave] Upload error:",t),c.showToast(`Upload failed: ${t.message}`,r.getAssetIDByName("ic_close_16px")),!1)))},E=n=>{if(!A()){c.showToast("Please configure Immich settings first!",r.getAssetIDByName("ic_close_16px"));return}const e=n.attachments;if(!e||e.length===0){c.showToast("No media found in this message",r.getAssetIDByName("ic_close_16px"));return}const i=e.filter(l=>{const d=l.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(l.filename),P=l.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(l.filename);return d||P});if(i.length===0){c.showToast("No image or video attachments found",r.getAssetIDByName("ic_close_16px"));return}console.log("[ImmichSave] Found media attachments:",i.length),c.showToast(`Uploading ${i.length} file(s) to Immich...`,r.getAssetIDByName("ic_upload"));let o=0,t=0,a=0;const B=l=>D(l.url,l.filename).then(d=>{d?o++:t++,a++,i.length>1&&c.showToast(`Progress: ${a}/${i.length} files processed`,r.getAssetIDByName("ic_check")),a===i.length&&(o>0&&c.showToast(`Successfully saved ${o} file(s) to Immich!`,r.getAssetIDByName("ic_check")),t>0&&c.showToast(`Failed to save ${t} file(s)`,r.getAssetIDByName("ic_close_16px")))}).catch(d=>{console.error("[ImmichSave] Error processing attachment:",d),t++,a++,a===i.length&&(o>0&&c.showToast(`Successfully saved ${o} file(s) to Immich!`,r.getAssetIDByName("ic_check")),t>0&&c.showToast(`Failed to save ${t} file(s)`,r.getAssetIDByName("ic_close_16px")))});i.forEach(l=>{B(l)})};var $={onLoad:()=>{console.log("[ImmichSave] Plugin loaded!"),w?(console.log("[ImmichSave] Found ActionSheet component, patching render method"),u=_.before("render",w,n=>{try{const[e]=n;console.log("[ImmichSave] ActionSheet render - full props:",{sheetKey:e.sheetKey,hasOptions:!!e.options,optionsCount:e.options?.length||0,allPropKeys:Object.keys(e),hasMessage:!!e.message,hasContent:!!e.content,hasData:!!e.data,title:e.title,header:e.header});const i=e.header?.props?.message;if(!i){console.log("[ImmichSave] Skipping ActionSheet - no message found in header.props");return}if(!i.attachments?.some(o=>{const t=o.content_type?.startsWith("image/")||/\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(o.filename),a=o.content_type?.startsWith("video/")||/\.(mp4|mov|avi|mkv|webm|m4v|3gp|flv|wmv)$/i.test(o.filename);return t||a})){console.log("[ImmichSave] Skipping - no image or video attachments found");return}if(console.log("[ImmichSave] Found message with media attachments - proceeding"),console.log("[ImmichSave] Children debug:",{hasChildren:!!e.children,childrenType:typeof e.children,childrenIsArray:Array.isArray(e.children),childrenLength:e.children?.length,children:e.children}),e.children&&Array.isArray(e.children)&&v)if(console.log("[ImmichSave] Attempting to add ActionSheetRow to children"),e.children.some(o=>o?.props?.label==="Save to Immich"))console.log("[ImmichSave] Save to Immich option already exists");else{const o=s.React.createElement(v,{key:"save-to-immich",label:"Save to Immich",icon:r.getAssetIDByName("ic_download"),onPress:()=>{try{console.log("[ImmichSave] Save to Immich pressed!"),E(i)}catch(t){console.error("[ImmichSave] Error in Save to Immich handler:",t),c.showToast("Error occurred",r.getAssetIDByName("ic_close_16px"))}}});e.children.unshift(o),console.log("[ImmichSave] Successfully added Save to Immich ActionSheetRow")}else console.log("[ImmichSave] Cannot add ActionSheetRow:",{hasChildren:!!e.children,isArray:Array.isArray(e.children),hasActionSheetRow:!!v})}catch(e){console.error("[ImmichSave] ActionSheet patch error:",e)}})):console.warn("[ImmichSave] Could not find ActionSheet component")},onUnload:()=>{u&&u()},settings:()=>{const[n,e]=s.React.useState(y()),[i,o]=s.React.useState(f()),t=()=>{F(n),c.showToast("API Key saved!",r.getAssetIDByName("ic_check"))},a=()=>{b(i),c.showToast("Server URL saved!",r.getAssetIDByName("ic_check"))};return s.React.createElement(s.React.Fragment,null,s.React.createElement(h.Forms.FormSection,{title:"Immich Configuration"},s.React.createElement(h.Forms.FormText,{style:{marginBottom:10}},"Configure your Immich server connection:"),s.React.createElement(h.Forms.FormInput,{placeholder:"Enter your Immich API Key",value:n,onChange:e,secureTextEntry:!0}),s.React.createElement(h.Forms.FormRow,{label:"Save API Key",onPress:t}),s.React.createElement(h.Forms.FormInput,{placeholder:"Enter Immich Server URL (e.g., https://immich.example.com)",value:i,onChange:o}),s.React.createElement(h.Forms.FormRow,{label:"Save Server URL",onPress:a})),s.React.createElement(h.Forms.FormSection,{title:"Status"},s.React.createElement(h.Forms.FormText,{style:{marginBottom:10}},A()?"\u2705 Immich is configured and ready to use!":"\u274C Please configure Immich settings above")))}};return g.default=$,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.ui.toasts,vendetta.patcher,vendetta.ui.assets,vendetta.metro,vendetta.plugin,vendetta.metro.common,vendetta.ui.components);
